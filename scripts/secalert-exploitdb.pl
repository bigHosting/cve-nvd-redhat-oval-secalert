#!/usr/bin/perl

use warnings;
use strict;

use POSIX qw(strftime);
use Mail::Sendmail;

my %EXPLOITS = ();
my $alert     = '';

my $date_today     = strftime "%Y-%m-%d", (localtime(time()) );
my $date_yesterday = strftime "%Y-%m-%d", ( localtime (time() - 24*60*60) );

my $file     = "/var/www/SITES/secalert.sec.domain.com/data/EXPLOITDB/files.csv";
if ( -f -r $file)
{
        open(EXP,"<$file");
        foreach my $line (<EXP>)
        {
                chomp($line);
                #41893,platforms/linux/dos/41893.txt,"pinfo 0.6.9 - Local Buffer Overflow",2017-04-18,"Nassim Asrir",linux,dos,0
                my ($id, $ref, $description, $date, $releaser, $os, $type, $last)=split(',', $line);
                next if ( ( $date !~ m/$date_today|$date_yesterday/) );
                $alert .= $line . "\n";
        }
        close(EXP);
}

if ( length ($alert) > 100)
{
        $alert .= "\n\nContent pulled from https://raw.githubusercontent.com/offensive-security/exploit-database/master/files.csv\n";
        # if manually testing, print on screen
        print $alert;

        my %mail = (
            from => 'securityteam@domain.com',
            to  => 'securityteam@domain.com',
            subject => "Vulnerability report for EXPLOITDB, published $date_yesterday and $date_today"
        );

        $mail{body}=$alert;
        sendmail(%mail) || print "Error in sending email\n";

}

